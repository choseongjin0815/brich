<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ktdsuniversity.edu.domain.campaign.dao.impl.AdminCategoryDaoImpl">
    
    <!-- 캠페인 카테고리 목록 -->
    <resultMap type="com.ktdsuniversity.edu.domain.campaign.vo.AdminCampaignCategoryVO" id="AdminCampaignCategoryVOMap" autoMapping="true">
        <result column="LEVEL" property="level"/>
        
        <result column="CD_ID" property="cdId"/>
        <result column="CD_NM" property="cdNm"/>
        <result column="PRNT_CD_ID" property="prntCdId"/>
        
        <result column="PRNT_CD_NM" property="prntCdNm"/>
        
        <result column="USE_YN" property="useYn"/>
        <result column="SRT" property="srt"/>
        <result column="CRT_DT" property="crtDt"/>
        <result column="CRTR" property="crtr"/>
        <result column="UPDT_DT" property="updtDt"/>
        <result column="MTTR" property="mttr"/>
        <result column="DLT_YN" property="dltYn"/>
    </resultMap>
    <select id="selectCampaignCategoryList" resultMap="AdminCampaignCategoryVOMap">
        SELECT LEVEL
             , CD_ID 
             , CD_NM
             , PRNT_CD_ID
             , PRIOR CD_NM AS PRNT_CD_NM
             , USE_YN
             , SRT
             , CRT_DT
             , CRTR
             , UPDT_DT
             , MTTR
             , DLT_YN
          FROM CM_CD
         START WITH PRNT_CD_ID = '3000'
       CONNECT BY PRIOR CD_ID = PRNT_CD_ID
         ORDER SIBLINGS BY SRT
    </select>
    
    <!-- 카테고리 분할 - 해당 카테고리의 하위 카테고리 출력 -->
    <select id="selectChildrenCategoryList" resultType="com.ktdsuniversity.edu.domain.campaign.vo.AdminCampaignCategoryVO" parameterType="string">
        SELECT CD_ID
             , CD_NM
          FROM CM_CD
         WHERE PRNT_CD_ID = #{_parameter}
           AND DLT_YN = 'N'
    </select>
    
    <!-- 카테고리 병합 - 해당 카테고리 제외, 상위 카테고리 출력 -->
    <select id="selectParentCategoryList" resultType="com.ktdsuniversity.edu.domain.campaign.vo.AdminCampaignCategoryVO" parameterType="string">
        SELECT CD_ID
             , CD_NM
          FROM CM_CD
         WHERE CD_ID != #{_parameter}
           AND PRNT_CD_ID = '3000'
           AND DLT_YN = 'N'
    </select>
    
    <!-- 현재 캠페인 카테고리 중 가장 마지막 cdId 값을 가져옴 -->
    <select id="selectLastCampaignCdId" resultType="string">
        SELECT MAX(CD_ID) AS LAST_CD_ID
          FROM CM_CD
         WHERE CD_ID BETWEEN '3001' AND '3999'
    </select>
    
    <!-- 현재 캠페인 카테고리 중 999를 제외한 가장 큰 srt 값을 가져옴 -->
    <select id="selectLastSrtNumber" resultType="_int">
        SELECT MAX(SRT) AS LAST_SRT
          FROM CM_CD
         WHERE CD_ID BETWEEN '3001' AND '3999'
           AND SRT != 999
    </select>
    
    <!-- 카테고리 추가 (INSERT) -->
    <insert id="insertNewCampaignCategory" parameterType="com.ktdsuniversity.edu.domain.campaign.vo.AdminCampaignCategoryVO">
        INSERT INTO CM_CD (CD_ID
                         , CD_NM
                         , PRNT_CD_ID
                         , USE_YN
                         , SRT
                         , KEY1
                         , VALUE1
                         , KEY2
                         , VALUE2
                         , KEY3
                         , VALUE3
                         , CRT_DT
                         , CRTR
                         , UPDT_DT
                         , MTTR
                         , DLT_YN)
                   VALUES (#{cdId}
                         , #{cdNm}
                         , '3000'
                         , 'Y'
                         , #{srt}
                         , NULL
                         , NULL
                         , NULL
                         , NULL
                         , NULL
                         , NULL
                         , SYSDATE
                         , #{adminId} 
                         , SYSDATE
                         , #{adminId}
                         , 'N')
    </insert>
    
</mapper>