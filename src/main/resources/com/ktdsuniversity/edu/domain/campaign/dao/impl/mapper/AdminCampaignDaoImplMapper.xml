<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ktdsuniversity.edu.domain.campaign.dao.impl.AdminCampaignDaoImpl">

    <select id="selectAdminCategoryParent" parameterType="string" resultType="string">
        SELECT CTG.CD_ID
          FROM (
                SELECT LEVEL AS LV, CD_ID, CD_NM, MAX(LEVEL) OVER () AS MAX_LV
                  FROM CM_CD
                 START WITH CD_ID = (SELECT CD_ID
                                       FROM CM_CD
                                      WHERE CD_NM = #{_parameter})
               CONNECT BY PRIOR PRNT_CD_ID = CD_ID
              ) CTG
          WHERE CTG.LV = CTG.MAX_LV - 1
    </select>
    
    <resultMap type="com.ktdsuniversity.edu.domain.campaign.vo.response.ResponseAdminCampaignVO" 
               id="RequestAdminCampaignVOMap"
               autoMapping="true">
               <id column="CMPN_ID" property="cmpnId"/>
               <collection property="area"
                           javaType="list"
                           ofType="java.lang.String">
                           <result property="area" column="AREA"/>
               </collection>
    </resultMap>
    <select id="selectAdminCampaignListCategoryAndSortBy"
            resultMap="RequestAdminCampaignVOMap"
            parameterType="com.ktdsuniversity.edu.domain.campaign.vo.request.RequestAdminSearchCampaignVO">
            <include refid="Common.paginationHeader" />
        SELECT CMPN.CMPN_ID 
                 , CMPN.OFFR_CN 
                 , CMPN.RCRT_PRSNN 
                 , CMPN.CMPN_TITLE
                 , CMPN.STTS_CD
                 , NVL(ADPT_TABLE.ADPT_CNT,0) AS ADPT_CNT
                 , CMPN.RCRT_STRT_DT 
                 , CMPN.RCRT_END_DT
                 , PARCD.CD_NM AS PARENT_AREA  
                 , ARCD.CD_NM AS AREA
              FROM CMPN CMPN 
              LEFT JOIN (SELECT CMPN_ID 
                              , COUNT(CMPN_ID) AS ADPT_CNT
                           FROM CMPN_PST_ADPT 
                          WHERE DLT_YN = 'N'
                          GROUP BY CMPN_ID) ADPT_TABLE
                     ON CMPN.CMPN_ID = ADPT_TABLE.CMPN_ID 
              LEFT JOIN CMPN_AR CMPNAR
                ON CMPN.CMPN_ID = CMPNAR.CMPN_ID 
              LEFT JOIN AR_CD ARCD
                ON CMPNAR.AR_CD = ARCD.CD_ID
              LEFT JOIN AR_CD PARCD
                ON PARCD.CD_ID = ARCD.PRNT_CD_ID 
             WHERE CMPN.CMPN_TITLE LIKE '%' || #{searchKeyword, jdbcType=VARCHAR} || '%'        
               AND CMPN.CTG_CD IN (SELECT CD_ID
                                     FROM CM_CD
                                    START WITH CD_ID = NVL(#{category, jdbcType=VARCHAR}, '3000')        
                                  CONNECT BY PRIOR CD_ID = PRNT_CD_ID)
              <choose>
                <!-- ÏµúÏã†Ïàú/Í∏∞Î≥∏ Î™©Î°ù (ÌïÑÌÑ∞ÎßÅ ÏóÜÏùå) -->
                <when test="sortBy == 'latest'">
                </when>
                <!-- Í≤ÄÌÜ† Ï§ë (under-review) -->
                <when test="sortBy == 'under-review'">
                  AND CMPN.STTS_CD = '2001'  /* üí° Ïã§Ï†ú ÏäπÏù∏ STTS_CDÎ°ú Î≥ÄÍ≤ΩÌïòÏÑ∏Ïöî. */
                </when>
                <!-- ÏäπÏù∏ (cnfm) -->
                <when test="sortBy == 'cnfm'">
                  AND CMPN.STTS_CD = '2002'  /* üí° Ïã§Ï†ú ÏäπÏù∏ STTS_CDÎ°ú Î≥ÄÍ≤ΩÌïòÏÑ∏Ïöî. */
                </when>
                
                <!-- Î∞òÎ†§ (rtrn) -->
                <when test="sortBy == 'rtrn'">
                  AND CMPN.STTS_CD = '2003'  /* üí° Ïã§Ï†ú Î∞òÎ†§ STTS_CDÎ°ú Î≥ÄÍ≤ΩÌïòÏÑ∏Ïöî. */
                </when>
                
                <!-- ÏãúÏûë ÎåÄÍ∏∞ (start-waiting) -->
                <when test="sortBy == 'start-waiting'">
                  AND CMPN.STTS_CD = '2004'  /* üí° Ïã§Ï†ú ÏãúÏûë ÎåÄÍ∏∞ STTS_CDÎ°ú Î≥ÄÍ≤ΩÌïòÏÑ∏Ïöî. */
                </when>
                
                <!-- Î™®Ïßë Ï§ë (recruiting) -->
                <when test="sortBy == 'recruiting'">
                  AND CMPN.STTS_CD = '2005'  /* üí° Ïã§Ï†ú Î™®Ïßë Ï§ë STTS_CDÎ°ú Î≥ÄÍ≤ΩÌïòÏÑ∏Ïöî. */
                </when>
                
                <!-- ÏÑ†Ï†ï Ï§ë (choice) -->
                <when test="sortBy == 'choice'">
                  AND CMPN.STTS_CD = '2006'  /* üí° Ïã§Ï†ú ÏÑ†Ï†ï Ï§ë STTS_CDÎ°ú Î≥ÄÍ≤ΩÌïòÏÑ∏Ïöî. */
                </when>
                
                <!-- ÏßÑÌñâ Ï§ë (start) -->
                <when test="sortBy == 'start'">
                  AND CMPN.STTS_CD = '2007'  /* üí° Ïã§Ï†ú ÏßÑÌñâ Ï§ë STTS_CDÎ°ú Î≥ÄÍ≤ΩÌïòÏÑ∏Ïöî. */
                </when>

                <!-- Ï¢ÖÎ£å (end) -->
                <when test="sortBy == 'end'">
                  AND CMPN.STTS_CD = '2009'  /* üí° Ïã§Ï†ú Ï¢ÖÎ£å STTS_CDÎ°ú Î≥ÄÍ≤ΩÌïòÏÑ∏Ïöî. */
                </when>
                
                <otherwise>
                  <!-- sortBy ÌååÎùºÎØ∏ÌÑ∞Í∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ (Í∏∞Î≥∏Í∞í) -->
                  <!-- ÌïÑÌÑ∞ÎßÅ ÏóÜÏùå. Î™®Îì† ÏÉÅÌÉúÎ•º Ï°∞Ìöå -->
                </otherwise>
              </choose>
              
              ORDER BY
                <!-- sortBy='latest'Ïùº Îïå '2001' (Í≤ÄÌÜ† Ï§ë) Ï∫†ÌéòÏù∏ÏùÑ ÏµúÏö∞ÏÑ† Ï†ïÎ†¨ -->
                CASE 
                    WHEN #{sortBy} = 'latest' 
                    THEN CASE 
                             WHEN CMPN.STTS_CD = '2001' 
                             THEN 0 ELSE 1 
                          END
                 END ASC 
                 <!-- sortByÍ∞Ä Îã§Î•∏ Í≤ΩÏö∞Ïùº Îïå, Î™®Îì† ÌïÑÌÑ∞ÎßÅ Î∞è Ï†ïÎ†¨ Ï°∞Í±¥ÏóêÏÑú ÏÉùÏÑ±Ïùº Í∏∞Ï§Ä ÏµúÏã†Ïàú Ï†ïÎ†¨ -->
                   , CMPN.CRT_DT DESC
            
          <include refid="Common.paginationFooter" />
    </select>

</mapper>