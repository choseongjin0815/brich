<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ktdsuniversity.edu.domain.campaign.dao.impl.CampaignDaoImpl">
    <resultMap id="ResponseApplicantVOMap"
               type="com.ktdsuniversity.edu.domain.campaign.vo.response.ResponseApplicantVO"
               autoMapping="true">
        <id column="CMPN_PST_ADPT_ID" property="cmpnPstAdptId" />
        <association property="userInfo"
                    javaType="com.ktdsuniversity.edu.domain.user.vo.UserVO"
                    autoMapping="true">
            <id column="USR_ID" property="usrId"></id>
        </association>
    </resultMap>
    <select id="selectApplicantListByCmpnId"
            resultMap="ResponseApplicantVOMap"
            parameterType="com.ktdsuniversity.edu.domain.campaign.vo.request.RequestApplicantVO">
        <include refid="Common.paginationHeader" />
        SELECT CPA.CMPN_PST_ADPT_ID
		     , CPA.ADPT_YN
		     , U.USR_ID
		     , U.LOG_ID
		     , U.PNLT_CNT
		     , U.BLG_ADDRS
		     , U.TTL_VSTR_CNT
		     , U.AVRG_VSTR_CNT
		     , U.BLG_NGHBR_CNT
		     , U.SCRP_CNT
		     , U.DLT_YN
		  FROM CMPN_PST_ADPT CPA
		 INNER JOIN (SELECT USR_ID
		                  , LOG_ID
		                  , PNLT_CNT
		                  , BLG_ADDRS
		                  , TTL_VSTR_CNT
		                  , AVRG_VSTR_CNT
		                  , BLG_NGHBR_CNT
		                  , SCRP_CNT
		                  , DLT_YN
		               FROM USR
		              WHERE DLT_YN  = 'N'
		                AND AUTR != '1005') U
		    ON U.USR_ID = CPA.BLG_USR_ID
		 WHERE CPA.CMPN_ID = #{cmpnId}
		   AND CPA.DLT_YN = 'N'
	   <if test="searchId != null and searchId != ''">
	       AND U.LOG_ID LIKE '%' || #{searchId} || '%'
	   </if>
       <if test='sortCol != null and sortCol != ""'>
		  ORDER BY NVL(${sortCol}, 0) ${order}  
       </if>
       <include refid="Common.paginationFooter" />
    </select>
    
    <select id="selectCampaignInfoByCmpnId"
            parameterType="string"
            resultType="com.ktdsuniversity.edu.domain.campaign.vo.CampaignVO">
        SELECT C.CMPN_ID
             , C.STTS_CD
		     , C.RCRT_PRSNN
		     , C.CMPN_TITLE
		     , TO_CHAR(C.CNFM_DT + 3, 'YYYY-MM-DD') AS CNFM_DT
		     , TO_CHAR(C.RCRT_STRT_DT, 'YYYY-MM-DD') AS RCRT_STRT_DT
		     , TO_CHAR(C.RCRT_END_DT, 'YYYY-MM-DD') AS RCRT_END_DT
		     , TO_CHAR(C.PST_END_DT, 'YYYY-MM-DD') AS PST_END_DT
		     , TO_CHAR(C.CMPN_END_DT, 'YYYY-MM-DD') AS CMPN_END_DT
		  FROM CMPN C
         WHERE CMPN_ID = #{_parameter}
    </select>
    
    <update id="updateAdptYnByCmpnPstAdptId"
            parameterType="com.ktdsuniversity.edu.domain.campaign.vo.request.RequestApplicantVO">
        UPDATE CMPN_PST_ADPT
           SET UPDT_DT = SYSDATE
             , MTTR = #{usrId}
        <if test='adptYn == "adopted"'>
             , ADPT_YN = 'N'
        </if>
        <if test='adptYn == "unadopted"'>
             , ADPT_YN = 'Y'
        </if>
         WHERE CMPN_PST_ADPT_ID = #{cmpnPstAdptId}
           AND DLT_YN = 'N'
    </update>
    
    <select id="selectAdoptCountByCmpnId"
            parameterType="string"
            resultType="_int">
        SELECT COUNT(ADPT_YN)
		  FROM CMPN_PST_ADPT
		 WHERE CMPN_ID = #{_parameter}
		   AND ADPT_YN = 'Y'
		   AND DLT_YN = 'N'
    </select>

    <select id="selectApplicantCountByCmpnId"
            parameterType="com.ktdsuniversity.edu.domain.campaign.vo.request.RequestApplicantVO"
            resultType="_int">
        SELECT COUNT(CPA.BLG_USR_ID)
          FROM CMPN_PST_ADPT CPA
         INNER JOIN (SELECT USR_ID
                          , LOG_ID
                          , PNLT_CNT
                          , BLG_ADDRS
                          , TTL_VSTR_CNT
                          , AVRG_VSTR_CNT
                          , BLG_NGHBR_CNT
                          , SCRP_CNT
                          , DLT_YN
                       FROM USR
                      WHERE DLT_YN  = 'N'
                        AND AUTR != '1005') U
            ON U.USR_ID = CPA.BLG_USR_ID
         WHERE CPA.CMPN_ID = #{cmpnId}
       <if test="searchId != null and searchId != ''">
           AND U.LOG_ID LIKE '%' || #{searchId} || '%'
       </if>
           AND CPA.DLT_YN = 'N'
       <if test='sortCol != null and sortCol != ""'>
          ORDER BY NVL(${sortCol}, 0) ${order}  
       </if>
    </select>
    
    <select id="selectCampaignStateByCmpnPstAdptId"
            parameterType="string"
            resultType="string">
        SELECT STTS_CD
		  FROM CMPN C
		 INNER JOIN CMPN_PST_ADPT CPA
		    ON C.CMPN_ID = CPA.CMPN_ID
		 WHERE CPA.CMPN_PST_ADPT_ID  = #{_parameter}
    </select>

    <select id="selectStateNameByStateCode"
            parameterType="string"
            resultType="string">
        SELECT CD_NM
          FROM CM_CD
         WHERE CD_ID = #{_parameter}
    </select>
    
    <resultMap id="ResponseAdoptVOMap"
               type="com.ktdsuniversity.edu.domain.campaign.vo.response.ResponseAdoptVO"
               autoMapping="true">
        <id property="cmpnPstAdptId" column="CMPN_PST_ADPT_ID" />
        <association property="userInfo"
                     javaType="com.ktdsuniversity.edu.domain.user.vo.UserVO"
                     autoMapping="true">
            <id property="usrId" column="USR_ID" />
        </association>
    </resultMap>
    <select id="selectAdoptListByCmpnId"
            resultMap="ResponseAdoptVOMap"
            parameterType="com.ktdsuniversity.edu.domain.campaign.vo.request.RequestApplicantVO">
        <include refid="Common.paginationHeader" />
        SELECT CPA.CMPN_PST_ADPT_ID
		     , CPA.PST_URL
		     , CPA.PST_STTS_CD
		     , CC.CD_NM AS POST_CD_NM
		     , TO_CHAR(CPA.PST_DDLN, 'YYYY-MM-DD') AS PST_DDLN
		     , U.USR_ID
		     , U.LOG_ID
		     , U.BLG_ADDRS
		  FROM CMPN_PST_ADPT CPA
		 INNER JOIN (SELECT USR_ID
                          , LOG_ID
                          , BLG_ADDRS
		               FROM USR
                      WHERE DLT_YN  = 'N'
                        AND AUTR != '1005') U
		    ON CPA.BLG_USR_ID = U.USR_ID
		 INNER JOIN CM_CD CC
		    ON CPA.PST_STTS_CD = CC.CD_ID 
		 WHERE CPA.CMPN_ID = #{cmpnId}
		   AND CPA.ADPT_YN = 'Y'
		   AND CPA.DLT_YN = 'N'
		<if test="searchId != null and searchId != ''">
           AND U.LOG_ID LIKE '%' || #{searchId} || '%'
       </if>
       <if test='sortCol != null and sortCol != ""'>
          ORDER BY NVL(${sortCol}, 0) ${order}  
       </if>
       <include refid="Common.paginationFooter" />
    </select>
    
    <select id="selectAdoptPaginationCount"
            parameterType="com.ktdsuniversity.edu.domain.campaign.vo.request.RequestApplicantVO"
            resultType="_int">
        SELECT COUNT(CPA.BLG_USR_ID)
          FROM CMPN_PST_ADPT CPA
         INNER JOIN (SELECT *
                       FROM USR
                      WHERE DLT_YN  = 'N'
                        AND AUTR != '1005') U
            ON CPA.BLG_USR_ID = U.USR_ID
         INNER JOIN CM_CD CC
            ON CPA.PST_STTS_CD = CC.CD_ID 
         WHERE CPA.CMPN_ID = #{cmpnId}
           AND CPA.ADPT_YN = 'Y'
           AND CPA.DLT_YN = 'N'
        <if test="searchId != null and searchId != ''">
           AND U.LOG_ID LIKE '%' || #{searchId} || '%'
       </if>
       <if test='sortCol != null and sortCol != ""'>
          ORDER BY NVL(${sortCol}, 0) ${order}  
       </if>
    </select>
    
    <update id="updatePstSttsByCmpnPstAdoptId"
            parameterType="com.ktdsuniversity.edu.domain.campaign.vo.request.RequestUpdatePstSttsVO">
        UPDATE CMPN_PST_ADPT
		   SET PST_STTS_CD = #{stts}
		     , UPDT_DT = SYSDATE
		     , MTTR = #{advId}
		 WHERE CMPN_PST_ADPT_ID = #{cmpnPstAdptId}
		   AND DLT_YN = 'N'
		   AND PST_DDLN >= SYSDATE
		   AND ADPT_YN = 'Y'
		   AND PST_URL IS NOT NULL
		   AND PST_STTS_CD = '6002'
    </update>
    
    <select id="selectDistrictByCdId"
            parameterType="string"
            resultType="com.ktdsuniversity.edu.global.common.CommonCodeVO">
        SELECT CD_ID
		     , CD_NM
		  FROM AR_CD
		 WHERE PRNT_CD_ID = #{_parameter}
		   AND DLT_YN = 'N'
    </select>
    
    <select id="selectPersonPrice"
            resultType="string">
        SELECT VALUE1
          FROM CM_CD
         WHERE CD_ID = '5000'
    </select>
    
    <insert id="insertDenyByCmpnPstAdoptId"
            parameterType="com.ktdsuniversity.edu.domain.campaign.vo.request.RequestDenyVO">
        <selectKey keyProperty="cmpnPstAdptId" resultType="string" order="BEFORE">
        SELECT 'PST_RTRN_HIST-' || TO_CHAR(SYSDATE, 'YYYYMMDD-') || LPAD(SEQ_POST_RTRN_HIST_PK.NEXTVAL, 6, '0')
          FROM DUAL
        </selectKey>
        INSERT INTO POST_RTRN_HIST
			  (POST_RTRN_HIST_ID
			 , POST_ID
			 , POST_RETN_RSN
			 , POST_SUBMIT_CHG_CN
			 , CRT_DT
			 , CRTR
			 , UPDT_DT
			 , MTTR
			 , DLT_YN
			 , RETN_FL_GRP_ID
			 , SUBMIT_FL_GRP_ID)
			 VALUES
			  (#{cmpnPstAdptId}
			 , #{cmpnPstAdptId}
			 , #{reason}
			 , NULL
			 , SYSDATE
			 , #{advId}
			 , SYSDATE
			 , #{advId}
			 , 'N'
			 , #{fileGroupId}
			 , NULL)
    </insert>
    
    <update id="updateDdlnByCmpnPstAdoptId"
            parameterType="com.ktdsuniversity.edu.domain.campaign.vo.request.RequestDenyVO">
        UPDATE CMPN_PST_ADPT
		   SET PST_DDLN = TO_DATE(#{pstDdln} || '23:59:59', 'YYYY-MM-DD HH24:MI:SS')
		     , UPDT_DT = SYSDATE
		     , MTTR = #{advId}
		 WHERE CMPN_PST_ADPT_ID  = #{cmpnPstAdptId}
		   AND DLT_YN = 'N'
    </update>
    
    <update id="udpateCmpnDateByCmpnId"
            parameterType="com.ktdsuniversity.edu.domain.campaign.vo.request.RequestDenyVO">
        UPDATE CMPN
		   SET PST_END_DT = (SELECT MAX(PST_DDLN)
		                       FROM CMPN_PST_ADPT
		                      WHERE CMPN_ID = #{cmpnId}
		                        AND DLT_YN = 'N')
		     , CMPN_END_DT = (SELECT MAX(PST_DDLN)
		                       FROM CMPN_PST_ADPT
		                      WHERE CMPN_ID = #{cmpnId}
		                        AND DLT_YN = 'N')
		     , UPDT_DT = SYSDATE
		     , MTTR = #{advId}
		 WHERE CMPN_ID = #{cmpnId}
		   AND DLT_YN = 'N'
    </update>
    
    <insert id="insertNewCampaign"
            parameterType="com.ktdsuniversity.edu.domain.campaign.vo.request.RequestCreateCmpnVO">
        <selectKey keyProperty="cmpnId" resultType="string" order="BEFORE">
            SELECT 'CMPN-' || TO_CHAR(SYSDATE, 'YYYYMMDD-') || LPAD(SEQ_CMPN_PK.NEXTVAL, 6, '0')
              FROM DUAL
        </selectKey>
    INSERT INTO CMPN
         ( CMPN_ID
         , USR_ID
         , CTG_CD
         , STTS_CD
         , PRSNN_PRC
         , DRTN_PRC
         , PRSNN_DSCNT
         , DRTN_DSCNT
         , CMPN_PRNT_ID
         , RCRT_STRT_DT
         , RCRT_PRSNN
         , PRGRSS_DRTN
         , RCRT_END_DT
         , PST_END_DT
         , CMPN_END_DT
         , RTRN_RSN
         , ADDRS
         , ATTCH_GRP_ID
         , CMPN_TITLE
         , CMPN_CN
         , OFFR_CN
         , OFFR_PRC
         , PST_MSSN
         , HSTG
         , NTFCN
         , "VIEW"
         , CNFM_DT
         , CRT_DT
         , CRTR
         , UPDT_DT
         , MTTR
         , DLT_YN)
        VALUES
        ( #{cmpnId}
        , #{usrId}
        , #{ctgCd}
        , '2001'
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , #{rcrtPrsnn}
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , #{addrs}
        , #{attchGrpId}
        , #{cmpnTitle}
        , #{cmpnCn}
        , #{offrCn}
        , #{offrPrc}
        , #{pstMssn}
        , #{ntfcn}
        , #{hstg}
        , 0
        , NULL
        , SYSDATE
        , #{usrId}
        , SYSDATE
        , #{usrId}
        , 'N')
    </insert>
    
    <select id="selectCampaignListByUsrId"
            parameterType="string"
            resultType="com.ktdsuniversity.edu.domain.campaign.vo.response.ResponseCampaignVO">
        SELECT C.CMPN_ID
             , C.STTS_CD 
             , CC.CD_NM AS STTS_CD_NM
             , TO_CHAR(C.RCRT_STRT_DT, 'YYYY-MM-DD') AS RCRT_STRT_DT
             , TO_CHAR(C.RCRT_END_DT, 'YYYY-MM-DD') AS RCRT_END_DT
             , TO_CHAR(C.PST_END_DT, 'YYYY-MM-DD') AS PST_END_DT
             , TO_CHAR(C.CMPN_END_DT, 'YYYY-MM-DD') AS CMPN_END_DT
             , C.ATTCH_GRP_ID
             , C.CMPN_TITLE
          FROM CMPN C
         INNER JOIN CM_CD CC
            ON C.STTS_CD = CC.CD_ID
         WHERE C.USR_ID = #{_parameter}
           AND C.DLT_YN = 'N'
    </select>
    
    <insert id="insertCampaignCategory"
            parameterType="com.ktdsuniversity.edu.domain.campaign.vo.request.RequestCampaignAreaVO">
        <selectKey keyProperty="cmpnArId" resultType="string" order="BEFORE">
            SELECT 'CMPN_AR-' || TO_CHAR(SYSDATE, 'YYYYMMDD-') || LPAD(SEQ_CMPN_AR_PK.NEXTVAL, 6, '0')
              FROM DUAL
        </selectKey>
        INSERT INTO CMPN_AR
             ( CMPN_AR_ID
             , CMPN_ID
             , AR_CD
             , CRT_DT
             , CRTR
             , UPDT_DT
             , MTTR
             , DLT_YN)
        VALUES
             ( #{cmpnArId}
             , #{cmpnId}
             , #{arCd}
             , SYSDATE
             , #{usrId}
             , SYSDATE
             , #{usrId}
             , 'N')
    </insert>
    
    <select id="selectCampaignDetailById"
            parameterType="map"
            resultMap="RequestCampaignVOMap">
			SELECT  CMPN.CMPN_ID
                  , CMPN.USR_ID
                  , CMPN.CTG_CD
                  , CMPN.STTS_CD
                  , CMPN.PRSNN_PRC
                  , CMPN.DRTN_PRC
                  , CMPN.PRSNN_DSCNT
                  , CMPN.DRTN_DSCNT
                  , CMPN.CMPN_PRNT_ID
                  , TO_CHAR(CMPN.RCRT_STRT_DT, 'MM-DD') AS RCRT_STRT_DT
                  , CMPN.RCRT_PRSNN
                  , CMPN.PRGRSS_DRTN
                  , TO_CHAR(CMPN.RCRT_END_DT, 'MM-DD')  AS RCRT_END_DT
                  , TO_CHAR(CMPN.PST_END_DT,  'MM-DD')  AS PST_END_DT
                  , TO_CHAR(CMPN.CMPN_END_DT, 'MM-DD')  AS CMPN_END_DT
                  , CMPN.RTRN_RSN
                  , CMPN.ADDRS
                  , CMPN.ATTCH_GRP_ID
                  , CMPN.CMPN_TITLE
                  , CMPN.CMPN_CN
                  , CMPN.OFFR_CN
                  , CMPN.OFFR_PRC
                  , CMPN.PST_MSSN
                  , CMPN.HSTG
                  , CMPN.NTFCN
                  , CMPN."VIEW"
                  , TO_CHAR(CMPN.CNFM_DT, 'MM-DD')       AS CNFM_DT
                  , TO_CHAR(CMPN.CRT_DT,  'MM-DD')       AS CRT_DT
                  , CMPN.CRTR
                  , TO_CHAR(CMPN.UPDT_DT, 'MM-DD')       AS UPDT_DT
                  , CMPN.MTTR
                  , CMPN.DLT_YN
                  , NVL(LIKE_TABLE.LIKE_CNT, 0)               AS LIKE_CNT
                  , NVL(ADPT_TABLE.ADPT_CNT, 0)               AS ADPT_CNT
                  , ARCD.CD_NM                                 AS AREA
                  , PARCD.CD_NM                                AS PARENT_AREA   
                  , ADPT.PST_STTS_CD
                  , CASE WHEN EXISTS (SELECT 1
                                        FROM CMPN_PST_ADPT 
                                       WHERE CMPN_ID = #{campaignId} 
                                     <if test="blgId != null and blgId != ''">
                                         AND BLG_USR_ID = #{blgId}
                                     </if>
                                         AND DLT_YN = 'N') 
                    THEN 'Y' ELSE 'N'
                    END                  AS ADPT_YN                   
              FROM CMPN CMPN 
              LEFT JOIN ( SELECT FAV.CMPN_ID  
                               , COUNT(FAV.CMPN_ID) AS LIKE_CNT
                            FROM FAV_CMPN FAV
                           WHERE FAV.CMPN_ID = #{campaignId}
                             AND FAV.DLT_YN = 'N'
                           GROUP BY  FAV.CMPN_ID) LIKE_TABLE
                     ON CMPN.CMPN_ID = LIKE_TABLE.CMPN_ID 
              LEFT JOIN ( SELECT ADPT.CMPN_ID 
                               , COUNT(ADPT.CMPN_ID) AS ADPT_CNT
                            FROM CMPN_PST_ADPT ADPT 
                           WHERE ADPT.CMPN_ID = #{campaignId}
                             AND ADPT.DLT_YN = 'N'
                           GROUP BY ADPT.CMPN_ID) ADPT_TABLE
                     ON CMPN.CMPN_ID = ADPT_TABLE.CMPN_ID 
             LEFT JOIN CMPN_AR CMPNAR
               ON CMPN.CMPN_ID = CMPNAR.CMPN_ID 
             LEFT JOIN AR_CD ARCD
               ON CMPNAR.AR_CD = ARCD.CD_ID
             LEFT JOIN AR_CD PARCD
               ON PARCD.CD_ID = ARCD.PRNT_CD_ID 
             LEFT JOIN (SELECT PST_STTS_CD
                             , CMPN_ID 
                          FROM CMPN_PST_ADPT
                         WHERE CMPN_ID = #{campaignId}
                           <if test="blgId != null and blgId != ''">
                           AND BLG_USR_ID = #{blgId}
                           </if>             ) ADPT
               ON CMPN.CMPN_ID = ADPT.CMPN_ID                
            WHERE CMPN.CMPN_ID = #{campaignId}
    </select>
    
    <select id="selectDoAndCityList"
            resultType="com.ktdsuniversity.edu.global.common.CommonCodeVO">
        SELECT CD_ID
             , CD_NM
          FROM AR_CD
         WHERE PRNT_CD_ID IS NULL
           AND DLT_YN = 'N'
    </select>
    
    <select id="selectCategoryList"
            resultType="com.ktdsuniversity.edu.global.common.CommonCodeVO">
     SELECT CD_ID
          , CD_NM
          , PRNT_CD_ID
          , USE_YN
          , SRT
          , KEY1
          , VALUE1
          , KEY2
          , VALUE2
          , KEY3
          , VALUE3
          , CRT_DT
          , CRTR
          , UPDT_DT
          , MTTR
          , DLT_YN 
      FROM CM_CD
     WHERE PRNT_CD_ID= '3000'
    </select>
    
     
    <select id="selectExpireSoonCampaign"
    		resultType="com.ktdsuniversity.edu.domain.campaign.vo.CampaignVO"
    		parameterType="com.ktdsuniversity.edu.domain.blog.vo.RequestExpireSoonCampaignVO">
        <include refid="Common.paginationHeader" />
    
    SELECT
      CMPN_ID,
      CMPN_TITLE,
      RCRT_END_DT,
      USR_ID,
      STTS_CD,
      CNFM_DT,
      OFFR_PRC
 FROM CMPN
WHERE DLT_YN = 'N'
  AND RCRT_END_DT <![CDATA[>]]> SYSDATE          
  AND RCRT_END_DT <![CDATA[<=]]> SYSDATE + 7     
ORDER BY RCRT_END_DT ASC
    <include refid="Common.paginationFooter"></include>
    </select>
    

    <resultMap type="com.ktdsuniversity.edu.domain.campaign.vo.response.ResponseCampaignVO" 
               id="RequestCampaignVOMap"
               autoMapping="true">
               <id column="CMPN_ID" property="cmpnId"/>
               <collection property="area"
                           javaType="list"
                           ofType="java.lang.String">
                           <result property="area" column="AREA"/>
               </collection>
    </resultMap>
    
    <select id="selectCampaignListCategoryAndSortBy"
            resultMap="RequestCampaignVOMap"
            parameterType="com.ktdsuniversity.edu.domain.campaign.vo.request.RequestSearchCampaignVO">
			SELECT CMPN.CMPN_ID 
			     , CMPN.OFFR_CN 
			     , CMPN.RCRT_PRSNN 
			     , CMPN.CMPN_TITLE
			     , NVL(LIKE_TABLE.LIKE_CNT,0) AS LIKE_CNT 
			     , NVL(ADPT_TABLE.ADPT_CNT,0) AS ADPT_CNT 
			     , CMPN.RCRT_STRT_DT 
			     , CMPN.RCRT_END_DT
			     , PARCD.CD_NM      AS PARENT_AREA  
			     , ARCD.CD_NM       AS AREA
                 , CASE WHEN EXISTS (
                                     SELECT 1
                                       FROM FAV_CMPN FC
                                      WHERE FC.BLG_USR_ID = #{loginId} 
                                        AND FC.CMPN_ID    = CMPN.CMPN_ID
                                        AND FC.DLT_YN     = 'N'
                       ) THEN 'Y' ELSE 'N'
                    END                  AS FAVYN			     
			  FROM CMPN CMPN 
			  LEFT JOIN ( SELECT FAV.CMPN_ID  
			                   , COUNT(FAV.CMPN_ID) AS LIKE_CNT
			                FROM FAV_CMPN FAV
			               WHERE FAV.CMPN_ID IN (SELECT CMPN_ID 
			                                           FROM CMPN
			                                      WHERE CMPN.CTG_CD  = '3001'   
			                                        AND CMPN.STTS_CD IN ( SELECT CD_ID
									                                        FROM CM_CD
									                                       START WITH CD_ID= NVL(#{category, jdbcType=VARCHAR}, '3000')        
									                                     CONNECT BY PRIOR CD_ID = PRNT_CD_ID)
			                                    )
			                 AND FAV.DLT_YN = 'N'
			               GROUP BY  FAV.CMPN_ID) LIKE_TABLE
			         ON CMPN.CMPN_ID = LIKE_TABLE.CMPN_ID 
			  LEFT JOIN ( SELECT ADPT.CMPN_ID 
			                   , COUNT(ADPT.CMPN_ID) AS ADPT_CNT
			                FROM CMPN_PST_ADPT ADPT 
			               WHERE ADPT.CMPN_ID IN (SELECT CMPN_ID 
			                                           FROM CMPN
			                                      WHERE CMPN.CTG_CD  IN ( SELECT CD_ID
                                                                            FROM CM_CD
                                                                           START WITH CD_ID= NVL(#{category, jdbcType=VARCHAR}, '3000')        
                                                                         CONNECT BY PRIOR CD_ID = PRNT_CD_ID)
			                                        AND CMPN.STTS_CD = '2005'
			                                     )
			                 AND ADPT.DLT_YN = 'N'
			               GROUP BY ADPT.CMPN_ID) ADPT_TABLE
			         ON CMPN.CMPN_ID = ADPT_TABLE.CMPN_ID 
			  LEFT JOIN CMPN_AR CMPNAR
			    ON CMPN.CMPN_ID = CMPNAR.CMPN_ID 
			  LEFT JOIN AR_CD ARCD
			    ON CMPNAR.AR_CD = ARCD.CD_ID
			  LEFT JOIN AR_CD PARCD
			    ON PARCD.CD_ID = ARCD.PRNT_CD_ID 
			 WHERE CMPN.CMPN_TITLE LIKE '%' || #{searchKeyword, jdbcType=VARCHAR} || '%'        
			   AND CMPN.CTG_CD IN (   SELECT CD_ID
			                            FROM CM_CD
			                           START WITH CD_ID= NVL(#{category, jdbcType=VARCHAR}, '3000')        
			                         CONNECT BY PRIOR CD_ID = PRNT_CD_ID)
			  AND CMPN.CTG_CD IN ( SELECT CD_ID
                                     FROM CM_CD
                                    START WITH CD_ID= NVL(#{category, jdbcType=VARCHAR}, '3000')        
                                  CONNECT BY PRIOR CD_ID = PRNT_CD_ID)  
			  AND CMPN.STTS_CD = '2005'   
			  ORDER BY
		        CASE WHEN #{sortBy} = 'latest'   THEN CMPN.RCRT_STRT_DT END  DESC ,
		        CASE WHEN #{sortBy} = 'deadline' THEN CMPN.RCRT_END_DT  END  ASC  ,
		        CASE WHEN #{sortBy} = 'popular'  THEN LIKE_CNT 		    END  DESC			   
    </select>
    

    <select id="selectCategoryParent"
            parameterType="string"
            resultType="string">    
			SELECT CTG.CD_ID
			FROM (
			      SELECT LEVEL AS lv, CD_ID, CD_NM, MAX(LEVEL) OVER () AS max_lv
			        FROM CM_CD
			       START WITH CD_ID = (SELECT CD_ID
			                             FROM CM_CD
			                            WHERE CD_NM= #{_parameter} )
			     CONNECT BY PRIOR PRNT_CD_ID = CD_ID ) CTG
			WHERE lv = max_lv - 1
    </select>
    
	
	<select id="selectCampaignChangeSttsCd"
			parameterType="string"
			resultType="string">
			SELECT CD_NM
			  FROM CM_CD
			 WHERE CD_ID = #{_parameter} 
	</select>
	
	
	<select id="selectMyCampaignByBlgId"
	        parameterType="map"
	        resultMap="RequestCampaignVOMap">
			SELECT U.USR_ID                               
			     , ADPT.CMPN_ID
			     , CMPN.CMPN_TITLE 
			     , CMPN.OFFR_CN 
			     , CMPN.RCRT_PRSNN
			     , CMPN.STTS_CD 
			     , ARCD.CD_NM                              AS AREA
			     , PARCD.CD_NM                             AS PARENT_AREA   
			     , NVL(ADPT_CNT.CNT, 0)                    AS ADPT_CNT
			     , CASE WHEN FC.CMPN_ID IS NULL THEN 'N'
			            ELSE 'Y'
			       END                                     AS FAV_YN
			     , ADPT.PST_STTS_CD       
			  FROM USR U
			 INNER JOIN CMPN_PST_ADPT ADPT
			    ON U.USR_ID = ADPT.BLG_USR_ID
			   AND ADPT.DLT_YN = 'N'
			 INNER JOIN CMPN CMPN
			    ON CMPN.CMPN_ID = ADPT.CMPN_ID
			   AND ADPT.DLT_YN = 'N'
			  LEFT JOIN (SELECT CMPN_ID
			                  , COUNT(CMPN_ID) AS CNT
			               FROM CMPN_PST_ADPT
			              WHERE ADPT_YN = 'Y'
			                AND DLT_YN  = 'N'
			              GROUP BY CMPN_ID
			             ) ADPT_CNT
			    ON ADPT_CNT.CMPN_ID = ADPT.CMPN_ID
			  LEFT JOIN FAV_CMPN FC
			    ON FC.BLG_USR_ID = U.USR_ID
			   AND FC.CMPN_ID    = ADPT.CMPN_ID
			   AND FC.DLT_YN     = 'N'
			  LEFT JOIN CMPN_AR CMPNAR
			    ON CMPN.CMPN_ID = CMPNAR.CMPN_ID 
			  LEFT JOIN AR_CD ARCD
			    ON CMPNAR.AR_CD = ARCD.CD_ID
			  LEFT JOIN AR_CD PARCD
			    ON PARCD.CD_ID = ARCD.PRNT_CD_ID   
			 WHERE U.USR_ID    = #{blgId}
			   AND ADPT.DLT_YN = 'N'
			  <if test="statuses != null and statuses.size() > 0">
			    AND CMPN.STTS_CD IN
			    <foreach collection="statuses" item="statuses" open="(" separator="," close=")">
			      #{statuses}
			    </foreach>
			  </if>
	</select>
	
    <select id="selectFavCamapignExists"
            parameterType="map"
            resultType="string">
			SELECT CASE 
			         WHEN EXISTS (SELECT 1
			                        FROM FAV_CMPN
			                       WHERE BLG_USR_ID = #{blgId}
			                         AND CMPN_ID = #{campaignId})
			         THEN 1 ELSE 0 
			       END AS CNT
			FROM DUAL
    </select>
    
    <insert id="insertFavCamapign"
            parameterType="map">
			INSERT INTO FAV_CMPN 
			VALUES 
			(#{blgId}
			,#{campaignId}
			,SYSDATE
			,#{blgId}
			,SYSDATE 
			,#{blgId}
			,'N')
    </insert>
    
    <select id="selectFavDltYn"
            parameterType="map"
            resultType="string">
			SELECT DLT_YN
			  FROM FAV_CMPN
			 WHERE BLG_USR_ID = #{blgId}
			   AND CMPN_ID = #{campaignId}
    </select>

    <update id="updateFavCamapignOn"
            parameterType="map">
			UPDATE FAV_CMPN
			   SET DLT_YN = 'N'
			 WHERE BLG_USR_ID = #{blgId}
			   AND CMPN_ID =#{campaignId}    
    </update>

    <update id="updateFavCamapignOff"
            parameterType="map">
			UPDATE FAV_CMPN
			   SET DLT_YN = 'Y'
			 WHERE BLG_USR_ID = #{blgId}
			   AND CMPN_ID =#{campaignId}
    </update>    
	
    <select id="selectMyFavCampaignByBlgId"
            parameterType="map"
            resultMap="RequestCampaignVOMap">
            SELECT CMPN.CMPN_ID
                 , CMPN.CMPN_TITLE 
                 , CMPN.OFFR_CN 
                 , CMPN.RCRT_PRSNN
                 , CMPN.STTS_CD 
                 , ARCD.CD_NM                              AS AREA
                 , PARCD.CD_NM                             AS PARENT_AREA   
                 , NVL(ADPT_CNT.CNT, 0)                    AS ADPT_CNT
                 , (SELECT 'Y' FROM DUAL)                  AS FAV_YN
              FROM CMPN CMPN
              LEFT JOIN CMPN_AR CMPNAR
                ON CMPN.CMPN_ID = CMPNAR.CMPN_ID 
              LEFT JOIN AR_CD ARCD
                ON CMPNAR.AR_CD = ARCD.CD_ID
              LEFT JOIN AR_CD PARCD
                ON PARCD.CD_ID = ARCD.PRNT_CD_ID   
              LEFT JOIN (SELECT CMPN_ID
                              , COUNT(CMPN_ID) AS CNT
                           FROM CMPN_PST_ADPT
                          WHERE ADPT_YN = 'Y'
                            AND DLT_YN  = 'N'
                          GROUP BY CMPN_ID
                         ) ADPT_CNT
                ON ADPT_CNT.CMPN_ID = CMPN.CMPN_ID    
             WHERE CMPN.CMPN_ID IN ( SELECT CMPN_ID
                                       FROM FAV_CMPN FC
                                      WHERE FC.BLG_USR_ID = #{blgId}
                                        AND FC.DLT_YN ='N')
               AND CMPN.STTS_CD IN 
				    <foreach collection="statuses" item="statuses" open="(" separator="," close=")">
				      #{statuses}
				    </foreach>                   
    </select>
        
    <insert id="insertApplyCampaign"
            parameterType="map">
			INSERT INTO CMPN_PST_ADPT
			( CMPN_PST_ADPT_ID
			, BLG_USR_ID
			, CMPN_ID
			, PST_URL
			, PST_STTS_CD
			, PST_DDLN
			, PST_SBMT_DT
			, PST_TITLE
			, CRT_DT
			, CRTR
			, UPDT_DT
			, MTTR)
			VALUES
			( 'CMPN-PST-ADPT-' || TO_CHAR(SYSDATE, 'YYYYMMDD-') || LPAD(SEQ_PST_DA_PK.NEXTVAL, 6, 0)
			, #{blgId}
			, #{campaignId}
			, NULL
			, NULL
			, NULL
			, NULL
			, NULL
			, SYSDATE
			, #{blgId}
			, SYSDATE
			, #{blgId} )    
    </insert>
	
	<select id="selecthasAdoptYn"
	        parameterType="map"
	        resultType="string">
			SELECT CASE 
			         WHEN EXISTS (  SELECT 1
			                          FROM CMPN_PST_ADPT 
			                         WHERE BLG_USR_ID = #{blgId}
			                           AND CMPN_ID = #{campaignId})
			         THEN 'Y' ELSE 'N' 
			       END AS CNT
			FROM DUAL
	</select>
	<select id="selectAdoptDltYn"
	        parameterType="map"
	        resultType="string">
			SELECT CASE 
			         WHEN EXISTS (  SELECT 1
			                          FROM CMPN_PST_ADPT 
			                         WHERE BLG_USR_ID = #{blgId}
			                           AND CMPN_ID = #{campaignId}
			                           AND DLT_YN = 'N')
			         THEN 'N' ELSE 'Y'
			       END AS CNT
			FROM DUAL
	</select>
	<update id="updateCancelApplyCampaign"
	        parameterType="map">
			UPDATE CMPN_PST_ADPT
			   SET DLT_YN = 'Y'
			 WHERE BLG_USR_ID = #{blgId}
			   AND CMPN_ID = #{campaignId}
	</update>
	<update id="updateApplyCampaign"
	        parameterType="map">
			UPDATE CMPN_PST_ADPT
			   SET DLT_YN = 'N'
			 WHERE BLG_USR_ID = #{blgId}
			   AND CMPN_ID = #{campaignId}
	</update>
	
</mapper>



