<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ktdsuniversity.edu.domain.chat.dao.impl.ChatDaoImpl">
    <!-- 추후 페이징 적용 -->
    <!-- 사용자가 참여 중인 채팅방 목록 조회 (메시지 정보는 MongoDB에서) -->
    <select id="selectUserChatRooms" 
            parameterType="string" 
            resultType="com.ktdsuniversity.edu.domain.chat.vo.response.ResponseChatRoomInfoVO">
        SELECT CR.CHT_RM_ID AS chtRmId,
		       C.CMPN_TITLE AS cmpnTitle,
		       C.CMPN_ID AS cmpnId,
		       C.STTS_CD AS sttsCd,
		       CD.CD_NM AS cdNm,
		       U.NM AS nm,
		       U.LOG_ID AS logId
		FROM CHT_PRTCPNT CP
		INNER JOIN CHT_RM CR
		    ON CP.CHT_RM_ID = CR.CHT_RM_ID
		INNER JOIN CMPN C
		    ON CR.CMPN_ID = C.CMPN_ID
		INNER JOIN CM_CD CD
		    ON CD.CD_ID = C.STTS_CD
		INNER JOIN CHT_PRTCPNT CP2
		    ON CP2.CHT_RM_ID = CR.CHT_RM_ID
		    AND CP2.USR_ID != #{usrId} 
		    AND CP2.LFT_YN = 'N'       
		INNER JOIN USR U
		    ON CP2.USR_ID = U.USR_ID 
		WHERE CP.USR_ID = #{usrId}
		  AND CP.LFT_YN = 'N'
		ORDER BY CR.CRT_DT DESC
    </select>

    <!-- 광고주용 채팅방 캠페인 목록 전체 -->
    <select id="selectAllCampaignList" 
            parameterType="string" 
            resultType="com.ktdsuniversity.edu.domain.chat.vo.response.ResponseChatCampaignListVO">
        SELECT C.CMPN_TITLE AS cmpnTitle
             , C.CMPN_ID AS cmpnId
             , C.STTS_CD AS sttsCd
             , CD.CD_NM AS cdNm
          FROM CHT_RM CR
         INNER JOIN CMPN C
            ON CR.CMPN_ID = C.CMPN_ID
         INNER JOIN CM_CD CD 
            ON CD.CD_ID = C.STTS_CD 
         WHERE C.USR_ID = #{usrId}
    </select>

    <!-- 광고주용 채팅방 캠페인 목록 종료 -->
    <select id="selectEndedCampaignList" parameterType="string" resultType="com.ktdsuniversity.edu.domain.chat.vo.response.ResponseChatCampaignListVO">
        SELECT C.CMPN_TITLE AS cmpnTitle
             , C.CMPN_ID AS cmpnId
             , C.STTS_CD AS sttsCd
             , CD.CD_NM AS cdNm
          FROM CHT_RM CR
         INNER JOIN CMPN C
            ON CR.CMPN_ID = C.CMPN_ID
         INNER JOIN CM_CD CD 
            ON CD.CD_ID = C.STTS_CD 
         WHERE C.USR_ID = #{usrId}
           AND C.STTS_CD = '2009'
    </select>

    <!-- 광고주용 채팅방 캠페인 목록 진행중 -->
    <select id="selectOngoingCampaignList" parameterType="string" resultType="com.ktdsuniversity.edu.domain.chat.vo.response.ResponseChatCampaignListVO">
        SELECT C.CMPN_TITLE AS cmpnTitle
             , C.CMPN_ID AS cmpnId
             , C.STTS_CD AS sttsCd
             , CD.CD_NM AS cdNm
          FROM CHT_RM CR
         INNER JOIN CMPN C
            ON CR.CMPN_ID = C.CMPN_ID
         INNER JOIN CM_CD CD 
            ON CD.CD_ID = C.STTS_CD 
         WHERE C.USR_ID = #{usrId}
           AND C.STTS_CD NOT IN ('2001', '2003', '2008', '2009')
    </select>

    <!-- 채팅방 나가기 -->
    <update id="updateChatRoomLeave" parameterType="com.ktdsuniversity.edu.domain.chat.vo.ChatParticipantVO">
        UPDATE CHT_PRTCPNT
           SET LFT_YN = 'Y',
               UPDT_DT = SYSDATE,
               MTTR = #{usrId}
         WHERE USR_ID = #{usrId}
           AND CHT_RM_ID = #{chtRmId}
    </update>

    <!-- 사용자 이름 조회 -->
    <select id="selectUserName" parameterType="string" resultType="string">
        SELECT NM
          FROM USR
         WHERE USR_ID = #{usrId}
    </select>
</mapper>